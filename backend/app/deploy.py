import json
from app.blockchain import w3

# 1. ABI - o'zingiz qo'ygan kod turaversin (u to'g'ri)
abi_data = """
[
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "_candidateId",
				"type": "uint256"
			}
		],
		"name": "votedEvent",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "candidates",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "voteCount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "candidatesCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_candidateId",
				"type": "uint256"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "voters",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
"""
abi = json.loads(abi_data)

# 2. Yangilangan Bytecode (Faqat kerakli qism)
bytecode = "608060405234801561000f575f5ffd5b506100546040518060400160405280601281526020017f536861766b6174204d69727a69796f796576000000000000000000000000000081525061009d60201b60201c565b6100986040518060400160405280600f81526020017f4e6f6d7a6f6420496b6b696e636869000000000000000000000000000000000081525061009d60201b60201c565b610492565b60025f8154809291906100af90610148565b9190505550604051806060016040528060025481526020018281526020015f81525060015f60025481526020019081526020015f205f820151815f0155602082015181600101908161010191906103c3565b506040820151816002015590505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f819050919050565b5f6101528261013f565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361018457610183610112565b5b600182019050919050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061020a57607f821691505b60208210810361021d5761021c6101c6565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261027f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610244565b6102898683610244565b95508019841693508086168417925050509392505050565b5f819050919050565b5f6102c46102bf6102ba8461013f565b6102a1565b61013f565b9050919050565b5f819050919050565b6102dd836102aa565b6102f16102e9826102cb565b848454610250565b825550505050565b5f5f905090565b6103086102f9565b6103138184846102d4565b505050565b5b818110156103365761032b5f82610300565b600181019050610319565b5050565b601f82111561037b5761034c81610223565b61035584610235565b81016020851015610364578190505b61037861037085610235565b830182610318565b50505b505050565b5f82821c905092915050565b5f61039b5f1984600802610380565b1980831691505092915050565b5f6103b3838361038c565b9150826002028217905092915050565b6103cc8261018f565b67ffffffffffffffff8111156103e5576103e4610199565b5b6103ef82546101f3565b6103fa82828561033a565b5f60209050601f83116001811461042b575f8415610419578287015190505b61042385826103a8565b86555061048a565b601f19841661043986610223565b5f5b828110156104605784890151825560018201915060208501945060208101905061043b565b8683101561047d5784890151610479601f89168261038c565b8355505b6001600288020188555050505b505050505050565b61071d8061049f5f395ff3fe608060405234801561000f575f5ffd5b506004361061004a575f3560e01c80630121b93f1461004e5780632d35a8a21461006a5780633477ee2e14610088578063a3ec138d146100ba575b5f5ffd5b61006860048036038101906100639190610375565b6100ea565b005b610072610270565b60405161007f91906103af565b60405180910390f35b6100a2600480360381019061009d9190610375565b610276565b6040516100b193929190610438565b60405180910390f35b6100d460048036038101906100cf91906104ce565b610322565b6040516100e19190610513565b60405180910390f35b5f5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff1615610173576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161016a90610576565b60405180910390fd5b5f8111801561018457506002548111155b6101c3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101ba906105de565b60405180910390fd5b60015f5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff02191690831515021790555060015f8281526020019081526020015f206002015f81548092919061023b90610629565b9190505550807ffff3c900d938d21d0990d786e819f29b8d05c1ef587b462b939609625b684b1660405160405180910390a250565b60025481565b6001602052805f5260405f205f91509050805f01549080600101805461029b9061069d565b80601f01602080910402602001604051908101604052809291908181526020018280546102c79061069d565b80156103125780601f106102e957610100808354040283529160200191610312565b820191905f5260205f20905b8154815290600101906020018083116102f557829003601f168201915b5050505050908060020154905083565b5f602052805f5260405f205f915054906101000a900460ff1681565b5f5ffd5b5f819050919050565b61035481610342565b811461035e575f5ffd5b50565b5f8135905061036f8161034b565b92915050565b5f6020828403121561038a5761038961033e565b5b5f61039784828501610361565b91505092915050565b6103a981610342565b82525050565b5f6020820190506103c25f8301846103a0565b92915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61040a826103c8565b61041481856103d2565b93506104248185602086016103e2565b61042d816103f0565b840191505092915050565b5f60608201905061044b5f8301866103a0565b818103602083015261045d8185610400565b905061046c60408301846103a0565b949350505050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61049d82610474565b9050919050565b6104ad81610493565b81146104b7575f5ffd5b50565b5f813590506104c8816104a4565b92915050565b5f602082840312156104e3576104e261033e565b5b5f6104f0848285016104ba565b91505092915050565b5f8115159050919050565b61050d816104f9565b82525050565b5f6020820190506105265f830184610504565b92915050565b7f53697a20616c6c61716163686f6e206f766f7a2062657267616e73697a2100005f82015250565b5f610560601e836103d2565b915061056b8261052c565b602082019050919050565b5f6020820190508181035f83015261058d81610554565b9050919050565b7f4e6f746f2767277269206e6f6d7a6f642074616e6c616e6469210000000000005f82015250565b5f6105c8601a836103d2565b91506105d382610594565b602082019050919050565b5f6020820190508181035f8301526105f5816105bc565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61063382610342565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610665576106646105fc565b5b600182019050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806106b457607f821691505b6020821081036106c7576106c6610670565b5b5091905056fea2646970667358221220a51a98532859b70ca1374c227c60c58f286b018b1dbb9bd4bdea8ef3b5cc7f9664736f6c63781c302e382e33312d7072652e312b636f6d6d69742e6235393536366636004d"

# 3. Deploy funktsiyasi (Bytecode'ga 0x qo'shish shart emas, men yuqorida qo'shib qo'ydim)
def deploy():
    try:
        account = w3.eth.accounts[0]
        # bytecode o'zgaruvchisida allaqachon 0x borligini tekshiring yoki pastdagidek yozing
        Contract = w3.eth.contract(abi=abi, bytecode="0x" + bytecode if not bytecode.startswith("0x") else bytecode)
        
        print("Kontrakt blokcheynga yuklanmoqda...")
        tx_hash = Contract.constructor().transact({'from': account})
        tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        
        print(f"--- Muvaffaqiyatli yuklandi! ---")
        print(f"KONTRAKT_MANZILI: {tx_receipt.contractAddress}")
        return tx_receipt.contractAddress
    except Exception as e:
        print(f"Xatolik yuz berdi: {e}")

if __name__ == "__main__":
    deploy()